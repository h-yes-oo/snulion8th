{% extends 'base.html' %}
{% block content %}
    <!-- 스크롤 버튼 -->
    <button class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored scroll-up">
        <i class="material-icons">UP</i>
    </button>
    <!-- 새로운 feed -->
    {% if user.is_authenticated %}
        <a href="{% url 'new' %}" class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored" >
            <i class="material-icons">add</i>
        </a>
    {% endif %}
    <!-- FEED -->
    {% for feed in feeds %} 
    <div class="demo-card-square mdl-card mdl-shadow--2dp">
        <div class="button-wrapper">
            <span>
                <i class="material-icons">mood</i>
                {{ feed.author.username }}
            </span>         
            <!-- 좋아요 버튼 -->
            <a href="{% url 'like' feed.id %}"
                class="material-icons mdl-badge mdl-badge--overlap feed-like" 
                data-badge="{{ feed.like_users.count }}" data-fid={{ feed.id }} 
                data-csrfmiddlewaretoken="{{ csrf_token }}">
                {% if user in feed.liked_users.all %}
                    <i class="material-icons">favorite</i>
                {% else %}
                    <i  class="material-icons">favorite_border</i>
                {% endif %}       
            </a>
            <!-- 더보기 버튼 -->
            <a href="{% url 'show' feed.id %}">
                더보기
            </a>
            <!-- 수정, 삭제 버튼 -->
            {% if request.user == feed.author %}  
                <a href="{% url 'edit' feed.id %}">
                    <i class="material-icons">edit</i>
                </a>                                   
                <a href="{% url 'delete' feed.id %}"
                    onclick="return confirm('정말 삭제하시겠습니까?')">
                    <i class="material-icons">delete</i>
                </a>
            {% endif %}   
        </div> 
        <!-- feed title -->
        <div class="mdl-card__title mdl-card--expand">
            <h2 class="mdl-card__title-text">{{ feed.title }}</h2>
        </div>
        <!-- feed content -->
        <div class="mdl-card__supporting-text">
            {{ feed.content }}<br/>
            {% if feed.photo %}
                <img src="{{ feed.photo.url }}" alt="" width="30%" height="20%">
            {% endif %}
        </div>
        <!-- feed comments -->
        <div class="comment-wrapper">
            {% for c in feed.feedcomment_set.all|dictsortreversed:'like_users.count' %}
                {% if c.id == feed.feedcomment_set.all.last.id %}
                    <!-- feed last comment -->   
                    <div class="toggle-comment last-comment">
                        <p>↳{{ c.author.username }}- {{ c.content }}</p>
                        {% if request.user == c.author %}    
                            <form action="/feeds/{{ feed.id }}/comments/{{ c.id }}/" method="POST">
                                {% comment %} class="comment-delete" data-fid="{{ feed.id }}" data-cid="{{ c.id }}" 
                                data-csrfmiddlewaretoken="{{ csrf_token }}"> {% endcomment %}
                                {% csrf_token %}
                                <button type="submit" class="mdl-button mdl-js-button mdl-button--icon">
                                    <i class="material-icons">clear</i>
                                </button>
                            </form>
                            {% comment %} <a href="/feeds/{{ feed.id }}/comment_like/{{ c.id }}/"
                                class = "comment-like" data-badge="{{ c.like_users.count }}"
                                data-fid={{ feed.id }} data-cid={{ c.id }} data-csrfmiddlewaretoken="{{ csrf_token }}"> 
                                {{ c.like_users.count }} likes
                            </a> {% endcomment %}
                        {% endif %}   
                    </div>
                {% else %}
                    <!-- the other comments -->
                    <div class="toggle-comment" style="display: none;"> 
                        <p>↳{{ c.author.username }}- {{ c.content }}</p> 
                        <form action="/feeds/{{ feed.id }}/comments/{{ c.id }}/" method="POST">
                            {% comment %} class="comment-delete" data-fid="{{ feed.id }}" data-cid="{{ c.id }}" 
                            data-csrfmiddlewaretoken="{{ csrf_token }}"> {% endcomment %}
                            {% csrf_token %}
                            <button type="submit" class="mdl-button mdl-js-button mdl-button--icon">
                                <i class="material-icons">clear</i>
                            </button>
                        </form>
                        <!-- comment like button -->
                        {% comment %} <a href="/feeds/{{ feed.id }}/comment_like/{{ c.id }}/"
                            class="material-icons mdl-badge mdl-badge--overlap comment-like" 
                            data-badge="{{ c.like_users.count }}" data-fid={{ feed.id }} 
                            data-cid={{ c.id }} data-csrfmiddlewaretoken="{{ csrf_token }}"> 
                            {% if user in feed.liked_users.all %}
                                <i class="material-icons">favorite</i>
                            {% else %}
                                <i  class="material-icons">favorite_border</i>
                            {% endif %}                         
                            </a> {% endcomment %}
                        <br/>
                    </div>
                {% endif %}                  
            {% endfor %}
            {% if user.is_authenticated %}
                <!-- create new comment -->
                <form action="/feeds/{{ feed.id }}/comments/" method="POST"
                    class="comment-submit" data-fid="{{ feed.id }}" data-username="{{request.user}}"
                    data-csrfmiddlewaretoken="{{ csrf_token }}" >
                    {% csrf_token %}
                    <div class="mdl-textfield mdl-js-textfield">
                        <input id="{{ feed.id }}" class="mdl-textfield__input" type="text" id="comment" name="content" required>
                        <label class="mdl-textfield__label" for="comment">Text...</label>
                        <button type="submit" class="mdl-button mdl-js-button mdl-button--icon">
                            <i class="material-icons">send</i>
                        </button>
                    </div>
                </form>
                {% if feed.feedcomment_set.all.count > 1 %}
                    <button class="more-comment-btn mdl-button mdl-js-button mdl-button--primary">
                        MORE COMMENTS
                    </button> 
                {% endif %}
            {% endif %}
            <div class="mdl-card__actions mdl-card--border">
                <!-- feed follow -->
                {% if user.is_authenticated %}
                    {% if request.user != feed.author %}
                        <a href="/accounts/{{ feed.author.id }}/follow" 
                            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                            작성자:<strong>{{feed.author.username}}</strong>
                            ({{ feed.author.profile.follow_to.all.count }} following,
                            {{ feed.author.profile.follow_from.all.count }} follower)
                            {% if request.user.profile not in feed.author.profile.follows.all %}
                                <button>팔로우</button>
                            {% else %}
                                <button>팔로우 취소</button>
                            {% endif %}
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %} <!-- for를 end시킨다는 뜻! 여기서는 들여쓰기로 끝을 못 내니 -->
{% endblock content %}
